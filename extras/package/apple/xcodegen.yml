name: VLC
options:
  bundleIdPrefix: org.videolan.vlc
  deploymentTarget:
    iOS: 9.0
configs:
  Debug: debug
  Release: release
  Debug-bitcode: debug
settings:
  configs:
    Debug:
      PBXCP_BITCODE_STRIP_MODE: replace-with-marker
      STRIP_BITCODE_FROM_COPIED_FILES: YES
    Debug-bitcode:
      STRIP_BITCODE_FROM_COPIED_FILES: NO
    Release:
      STRIP_BITCODE_FROM_COPIED_FILES: NO
targets:
  VLCAutomake:
    type: ""
    platform: ${VLC_PLATFORM}
    legacy:
      toolPath: ${VLC_BUILD_DIR}/compile
      passSettings: false
      attributes: -C ${VLC_BUILD_DIR}
      workingDirectory: ${VLC_BUILD_DIR}
    sources:
      - path: "${VLC_SRC_DIR}/src"
        excludes: "**/Makefile.in"
      - path: "${VLC_SRC_DIR}/include"
        excludes: "**/Makefile.in"
      - path: "${VLC_SRC_DIR}/modules"
        excludes: "**/Makefile.in"
      - path: "${VLC_SRC_DIR}/lib"
        excludes: "**/Makefile.in"

  vlccoreios:
    type: "application"
    platform: ${VLC_PLATFORM}
    dependencies:
      - target: VLCAutomake
    info:
      path: "vlccoreios/Info.plist"
    sources:
      - path: ${VLC_BUILD_DIR}/test/vlccoreios
        type: file
        optional: true
        attributes:
          - CodeSignOnCopy
        buildPhase:
          copyFiles:
            destination: executables

  vlccoreiostuner:
    type: "application"
    platform: ${VLC_PLATFORM}
    dependencies:
      - target: VLCAutomake
    info:
      path: "vlccoreiostuner/Info.plist"
    sources:
      - path: ${VLC_BUILD_DIR}/test/vlccoreiostuner
        type: file
        optional: true
        attributes:
          - CodeSignOnCopy
        buildPhase:
          copyFiles:
            destination: executables

  vlc_static_modules:
    type: "library.static"
    platform: ${VLC_PLATFORM}
    dependencies:
      - target: VLCAutomake
    sources:
      - path: ${VLC_BUILD_DIR}/modules/.libs/libvlc_static_modules.a
        optional: true
        buildPhase:
          copyFiles:
            destination: productsDirectory

  vlc_plugin:
    type: "framework"
    platform: ${VLC_PLATFORM}
    dependencies:
      - target: VLCAutomake
    info:
      path: "vlc_plugin/Info.plist"
    postBuildScripts:
      - name: Copy vlc_plugin library
        script: |
            INPUT_FILES=()
            for arch in ${ARCHS}; do
                input_file="${BUILT_PRODUCTS_DIR}/build-${PLATFORM_NAME}-${arch}/build/modules/.libs/libvlc_plugin.dylib"
                echo " + Adding input $input_file"
                INPUT_FILES+=( "$input_file" )
            done
            lipo -create \
                -output "${BUILT_PRODUCTS_DIR}/vlc_plugin.framework/vlc_plugin" \
                "${INPUT_FILES[@]}"

                # mv ${BUILT_PRODUCTS_DIR}/vlc_plugin.framework/libvlc_plugin.dylib \
                # ${BUILT_PRODUCTS_DIR}/vlc_plugin.framework/vlc_plugin
                # install_name_tool -id @rpath/vlc_plugin.framework/vlc_plugin \
                # ${BUILT_PRODUCTS_DIR}/vlc_plugin.framework/vlc_plugin
                # install_name_tool -change @rpath/libvlccore.dylib @rpath/vlccore.framework/vlccore \
                # ${BUILT_PRODUCTS_DIR}/vlc_plugin.framework/vlc_plugin

  vlc:
    type: "library.static"
    platform: ${VLC_PLATFORM}
    dependencies:
      - target: VLCAutomake
    postBuildScripts:
      - name: Copy libvlc library
        script: |
            INPUT_FILES=()
            for arch in ${ARCHS}; do
                input_file="${BUILT_PRODUCTS_DIR}/build-${PLATFORM_NAME}-${arch}/build/lib/.libs/libvlc.a"
                echo " + Adding input $input_file"
                INPUT_FILES+=( "$input_file" )
            done
            lipo -create \
                -output "${BUILT_PRODUCTS_DIR}/libvlc.a" \
                "${INPUT_FILES[@]}"

  vlccore:
    type: "framework"
    platform: ${VLC_PLATFORM}
    dependencies:
      - target: VLCAutomake
    info:
      path: "vlccore/Info.plist"
    sources:
      - path: ${VLC_SRC_DIR}/include/
        includes: "vlc_*.h"
        buildPhase: headers
        headerVisibility: public
    postBuildScripts:
      - name: Copy vlccore library
        script: |
            INPUT_FILES=()
            for arch in ${ARCHS}; do
                input_file="${BUILT_PRODUCTS_DIR}/build-${PLATFORM_NAME}-${arch}/build/src/.libs/libvlccore.dylib"
                echo " + Adding input $input_file"
                INPUT_FILES+=( "$input_file" )
            done
            lipo -create \
                -output "${BUILT_PRODUCTS_DIR}/vlccore.framework/vlccore" \
                "${INPUT_FILES[@]}"
